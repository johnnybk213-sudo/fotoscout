<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FotoScout</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0d1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FotoScout">
<meta name="description" content="Personlig foto-planl√¶gger til Vestkysten">
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --text-bright: #ffffff;
    --border: #30363d;
    --pin: #4a7fff;
    --pin-bg: rgba(74,127,255,0.12);
    --cam: #f0a030;
    --cam-bg: rgba(240,160,48,0.12);
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-tap-highlight-color: transparent;
  }

  /* Header */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(13,17,23,0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    padding: 16px;
    padding-top: max(16px, env(safe-area-inset-top));
    border-bottom: 1px solid var(--border);
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .logo { font-size: 22px; font-weight: 800; }
  .logo span { color: var(--cam); }

  .location-name {
    font-size: 13px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .gps-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #3fb950;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  /* Filters */
  .filters {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }

  .filters::-webkit-scrollbar { display: none; }

  .pill {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }

  .pill.active { background: var(--cam); color: var(--bg); border-color: var(--cam); }
  .pill.active-loc { background: var(--pin); color: #fff; border-color: var(--pin); }
  .pill.active-insp { background: var(--cam); color: var(--bg); border-color: var(--cam); }

  /* Status */
  .status {
    padding: 10px 16px;
    font-size: 13px;
    color: var(--text-dim);
  }

  .status .count { color: var(--cam); font-weight: 700; }

  /* Loading */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 80px 20px;
    gap: 16px;
  }

  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--cam);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { font-size: 14px; color: var(--text-dim); }

  /* Cards */
  .cards {
    padding: 8px 16px 100px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
    transition: transform 0.15s;
  }

  .card:active { transform: scale(0.98); }

  .card-img {
    position: relative;
    width: 100%;
    height: 200px;
    background: #0a0e14;
    overflow: hidden;
  }

  .card-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-img .placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-size: 48px;
    opacity: 0.15;
  }

  .card-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    padding: 3px 10px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .card-badge.loc { background: var(--pin); }
  .card-badge.insp { background: var(--cam); }

  .card-distance {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-bright);
  }

  .card-body { padding: 14px 16px 16px; }

  .card-name {
    font-size: 17px;
    font-weight: 700;
    color: var(--text-bright);
    margin-bottom: 4px;
  }

  .card-location {
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .card-notes {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-bottom: 10px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .card-tag {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
  }

  .card-tag.loc { background: var(--pin-bg); color: var(--pin); }
  .card-tag.insp { background: var(--cam-bg); color: var(--cam); }

  .card-footer { display: flex; gap: 8px; }

  .card-footer a {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.15s;
  }

  .btn-nav {
    background: var(--pin);
    color: #fff;
  }

  .btn-nav:active { background: #3a6fee; }

  .btn-nav.insp-nav {
    background: var(--cam);
    color: var(--bg);
  }

  .btn-nav.insp-nav:active { background: #e09020; }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-dim);
  }

  .empty .icon { font-size: 48px; margin-bottom: 16px; }
  .empty p { font-size: 15px; line-height: 1.6; }
  .empty .sub { font-size: 13px; margin-top: 8px; }

  /* Detail overlay */
  .detail-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg);
    z-index: 200;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .detail-overlay.open { display: block; }

  .detail-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(13,17,23,0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    padding: 12px 16px;
    padding-top: max(12px, env(safe-area-inset-top));
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .detail-back {
    background: none;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 18px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .detail-title {
    font-size: 17px;
    font-weight: 700;
    color: var(--text-bright);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .detail-badge {
    padding: 3px 10px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
  }

  .detail-badge.loc { background: var(--pin); }
  .detail-badge.insp { background: var(--cam); }

  /* Gallery */
  .gallery {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .gallery::-webkit-scrollbar { display: none; }

  .gallery-img {
    flex: 0 0 100%;
    scroll-snap-align: start;
    height: 280px;
    background: #0a0e14;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gallery-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gallery-placeholder {
    font-size: 64px;
    opacity: 0.15;
  }

  .gallery-counter {
    text-align: center;
    padding: 8px;
    font-size: 12px;
    color: var(--text-dim);
  }

  .gallery-dots {
    display: flex;
    justify-content: center;
    gap: 6px;
    padding: 8px;
  }

  .gallery-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
    transition: background 0.2s;
  }

  .gallery-dot.active { background: var(--cam); }

  .detail-body {
    padding: 20px 16px 100px;
  }

  .detail-location {
    font-size: 14px;
    color: var(--text-dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .detail-dist {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    background: rgba(255,255,255,0.06);
    color: var(--text);
    margin-left: 8px;
  }

  .detail-notes {
    font-size: 15px;
    color: var(--text);
    line-height: 1.7;
    margin-bottom: 16px;
  }

  .detail-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .detail-tag {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }

  .detail-tag.loc { background: var(--pin-bg); color: var(--pin); }
  .detail-tag.insp { background: var(--cam-bg); color: var(--cam); }

  .detail-nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    text-decoration: none;
    color: #fff;
  }

  .detail-nav-btn.loc { background: var(--pin); }
  .detail-nav-btn.insp { background: var(--cam); color: var(--bg); }

  /* Admin link */
  .admin-link {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--card);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    text-decoration: none;
    z-index: 99;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div class="logo">Foto<span>Scout</span></div>
    <div class="location-name">
      <span class="gps-dot"></span>
      <span id="locationName">Finder position...</span>
    </div>
  </div>
  <div class="filters" id="filters">
    <button class="pill active" data-filter="all">Alle</button>
    <button class="pill" data-filter="locations">Lokationer</button>
    <button class="pill" data-filter="inspirations">Inspiration</button>
  </div>
</div>

<div class="status" id="status">Indl√¶ser...</div>

<div id="content">
  <div class="loading">
    <div class="spinner"></div>
    <div class="loading-text">Finder din position...</div>
  </div>
</div>

<!-- Detail view -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-header">
    <button class="detail-back" onclick="closeDetail()">&#8592;</button>
    <div class="detail-title" id="detailTitle"></div>
    <span class="detail-badge" id="detailBadge"></span>
  </div>
  <div id="detailContent"></div>
</div>

<a href="./admin.html" class="admin-link" title="Admin">&#9881;</a>

<script>
// ============================================================
// FotoScout App
// ============================================================

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

const state = {
  lat: null,
  lon: null,
  data: { locations: [], inspirations: [] },
  filter: 'all',
  items: []
};

// --- Haversine ---
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function formatDist(km) {
  if (km === null) return '';
  return km < 1 ? `${Math.round(km*1000)} m` : `${km.toFixed(1)} km`;
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// --- Geolocation ---
function getPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation ikke tilg√¶ngelig'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 300000 }
    );
  });
}

async function reverseGeocode(lat, lon) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=da`);
    const d = await res.json();
    const addr = d.address;
    return addr.city || addr.town || addr.village || addr.municipality || addr.county || `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
  } catch {
    return `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
  }
}

// --- Load data ---
async function loadData() {
  try {
    const res = await fetch('./data.json?' + Date.now());
    if (res.ok) {
      state.data = await res.json();
    }
  } catch {}

  // Check localStorage for newer data
  const saved = localStorage.getItem('fotoscout-data');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (parsed._modified && parsed.locations) {
        state.data = parsed;
      }
    } catch {}
  }
}

// --- Build items list ---
function buildItems() {
  const items = [];

  for (const loc of state.data.locations) {
    let dist = null;
    if (state.lat !== null && loc.lat && loc.lon) {
      dist = haversine(state.lat, state.lon, loc.lat, loc.lon);
    }
    items.push({
      type: 'location',
      id: loc.id,
      name: loc.name,
      subtitle: loc.address,
      notes: loc.notes,
      photos: loc.photos || [],
      photo: (loc.photos && loc.photos.length > 0) ? loc.photos[0] : '',
      tags: loc.tags || [],
      lat: loc.lat,
      lon: loc.lon,
      dist,
      navTarget: loc.address
    });
  }

  for (const insp of state.data.inspirations) {
    let dist = null;
    if (state.lat !== null && insp.lat && insp.lon) {
      dist = haversine(state.lat, state.lon, insp.lat, insp.lon);
    }
    items.push({
      type: 'inspiration',
      id: insp.id,
      name: insp.title,
      subtitle: insp.area,
      notes: insp.notes,
      photo: insp.photo || '',
      photos: insp.photo ? [insp.photo] : [],
      tags: insp.tags || [],
      lat: insp.lat,
      lon: insp.lon,
      dist,
      navTarget: (insp.lat && insp.lon) ? `${insp.lat},${insp.lon}` : insp.area + ', Danmark'
    });
  }

  // Sort: items with distance first (by distance), then items without
  items.sort((a, b) => {
    if (a.dist !== null && b.dist !== null) return a.dist - b.dist;
    if (a.dist !== null) return -1;
    if (b.dist !== null) return 1;
    return 0;
  });

  state.items = items;
}

// --- Filter ---
function getFilteredItems() {
  if (state.filter === 'all') return state.items;
  if (state.filter === 'locations') return state.items.filter(i => i.type === 'location');
  if (state.filter === 'inspirations') return state.items.filter(i => i.type === 'inspiration');
  // Tag filter
  return state.items.filter(i => i.tags.includes(state.filter));
}

// --- Render ---
function render() {
  const filtered = getFilteredItems();
  const statusEl = document.getElementById('status');
  const content = document.getElementById('content');

  const locCount = state.data.locations.length;
  const inspCount = state.data.inspirations.length;
  statusEl.innerHTML = `<span class="count">${filtered.length}</span> af ${locCount + inspCount} steder`;

  if (filtered.length === 0) {
    content.innerHTML = `
      <div class="empty">
        <div class="icon">üì∑</div>
        <p>Ingen fotospots${state.filter !== 'all' ? ' i dette filter' : ''}</p>
        <p class="sub">Tilf√∏j lokationer og inspiration via Admin (tandhjulet)</p>
      </div>`;
    return;
  }

  content.innerHTML = '<div class="cards">' + filtered.map(item => {
    const isLoc = item.type === 'location';
    const badge = isLoc ? '<span class="card-badge loc">üìç Lokation</span>' : '<span class="card-badge insp">üì∏ Inspiration</span>';
    const distHtml = item.dist !== null ? `<span class="card-distance">${formatDist(item.dist)}</span>` : '';
    const imgHtml = item.photo
      ? `<img src="${item.photo}" alt="${esc(item.name)}" loading="lazy">`
      : `<div class="placeholder">${isLoc ? 'üìç' : 'üì∏'}</div>`;
    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.navTarget)}`;
    const tagCls = isLoc ? 'loc' : 'insp';
    const btnCls = isLoc ? 'btn-nav' : 'btn-nav insp-nav';

    const photoCount = item.photos.length;
    const countBadge = photoCount > 1 ? `<span style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,0.7);padding:3px 8px;border-radius:12px;font-size:11px;color:#fff;">${photoCount} billeder</span>` : '';

    return `
      <div class="card" onclick="openDetail('${item.id}')" style="cursor:pointer">
        <div class="card-img">
          ${imgHtml}
          ${badge}
          ${distHtml}
          ${countBadge}
        </div>
        <div class="card-body">
          <div class="card-name">${esc(item.name)}</div>
          <div class="card-location">${isLoc ? 'üìç' : 'üì∏'} ${esc(item.subtitle)}</div>
          ${item.notes ? `<div class="card-notes">${esc(item.notes)}</div>` : ''}
          ${item.tags.length ? `<div class="card-tags">${item.tags.map(t => `<span class="card-tag ${tagCls}">${esc(t)}</span>`).join('')}</div>` : ''}
        </div>
      </div>`;
  }).join('') + '</div>';

  // Add tag pills to filter
  renderTagFilters();
}

function renderTagFilters() {
  const allTags = new Set();
  state.items.forEach(i => i.tags.forEach(t => allTags.add(t)));

  const filtersEl = document.getElementById('filters');
  const basePills = `
    <button class="pill ${state.filter === 'all' ? 'active' : ''}" data-filter="all">Alle</button>
    <button class="pill ${state.filter === 'locations' ? 'active-loc' : ''}" data-filter="locations">üìç Lokationer</button>
    <button class="pill ${state.filter === 'inspirations' ? 'active-insp' : ''}" data-filter="inspirations">üì∏ Inspiration</button>
  `;

  const tagPills = [...allTags].sort().map(t =>
    `<button class="pill ${state.filter === t ? 'active' : ''}" data-filter="${esc(t)}">${esc(t)}</button>`
  ).join('');

  filtersEl.innerHTML = basePills + tagPills;
}

// --- Filter click ---
document.getElementById('filters').addEventListener('click', e => {
  const pill = e.target.closest('.pill');
  if (!pill) return;
  state.filter = pill.dataset.filter;
  render();
});

// --- Detail view ---
function openDetail(id) {
  const item = state.items.find(i => i.id === id);
  if (!item) return;

  const isLoc = item.type === 'location';
  const overlay = document.getElementById('detailOverlay');
  const titleEl = document.getElementById('detailTitle');
  const badgeEl = document.getElementById('detailBadge');
  const contentEl = document.getElementById('detailContent');

  titleEl.textContent = item.name;
  badgeEl.textContent = isLoc ? 'üìç Lokation' : 'üì∏ Inspiration';
  badgeEl.className = `detail-badge ${isLoc ? 'loc' : 'insp'}`;

  // Gallery
  const photos = item.photos.filter(p => p);
  let galleryHtml = '';
  if (photos.length > 0) {
    galleryHtml = `
      <div class="gallery" id="gallery" onscroll="updateGalleryDots()">
        ${photos.map(p => `<div class="gallery-img"><img src="${p}" alt="${esc(item.name)}"></div>`).join('')}
      </div>
      ${photos.length > 1 ? `
        <div class="gallery-dots" id="galleryDots">
          ${photos.map((_, i) => `<div class="gallery-dot ${i === 0 ? 'active' : ''}"></div>`).join('')}
        </div>
      ` : ''}
    `;
  } else {
    galleryHtml = `<div class="gallery-img"><div class="gallery-placeholder">${isLoc ? 'üìç' : 'üì∏'}</div></div>`;
  }

  const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.navTarget)}`;
  const tagCls = isLoc ? 'loc' : 'insp';
  const btnCls = isLoc ? 'loc' : 'insp';

  contentEl.innerHTML = `
    ${galleryHtml}
    <div class="detail-body">
      <div class="detail-location">
        ${isLoc ? 'üìç' : 'üì∏'} ${esc(item.subtitle)}
        ${item.dist !== null ? `<span class="detail-dist">üìè ${formatDist(item.dist)}</span>` : ''}
      </div>
      ${item.notes ? `<div class="detail-notes">${esc(item.notes)}</div>` : ''}
      ${item.tags.length ? `<div class="detail-tags">${item.tags.map(t => `<span class="detail-tag ${tagCls}">${esc(t)}</span>`).join('')}</div>` : ''}
      <a href="${navUrl}" target="_blank" rel="noopener" class="detail-nav-btn ${btnCls}">üìç Navig√©r hertil</a>
    </div>
  `;

  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

function updateGalleryDots() {
  const gallery = document.getElementById('gallery');
  const dots = document.querySelectorAll('#galleryDots .gallery-dot');
  if (!gallery || dots.length === 0) return;
  const idx = Math.round(gallery.scrollLeft / gallery.offsetWidth);
  dots.forEach((d, i) => d.classList.toggle('active', i === idx));
}

// Back button / swipe to close
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeDetail();
});

// --- Init ---
async function init() {
  await loadData();

  // Try geolocation
  try {
    const pos = await getPosition();
    state.lat = pos.lat;
    state.lon = pos.lon;
    const name = await reverseGeocode(pos.lat, pos.lon);
    document.getElementById('locationName').textContent = name;
  } catch {
    document.getElementById('locationName').textContent = 'Ingen GPS';
    document.querySelector('.gps-dot').style.background = '#8b949e';
  }

  buildItems();
  render();
}

init();
</script>
</body>
</html>
